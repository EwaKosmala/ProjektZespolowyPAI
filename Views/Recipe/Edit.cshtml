@model lab1_gr1.ViewModels.RecipeVM.CreateRecipeVM

@{
    ViewData["Title"] = "Edytuj przepis";
}

<h2>Edytuj przepis</h2>

@if (!ViewData.ModelState.IsValid)
{
    <div style="color:red;">
        @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
        {
            <p>@error.ErrorMessage</p>
        }
    </div>
}

<form asp-action="Edit" asp-route-id="@ViewBag.RecipeId" method="post">
    <div>
        <label for="Name">Nazwa przepisu</label>
        <input asp-for="Name" />
        <span asp-validation-for="Name" style="color:red"></span>
    </div>

    <div>
        <label for="Description">Opis</label>
        <textarea asp-for="Description"></textarea>
        <span asp-validation-for="Description" style="color:red"></span>
    </div>

    <div>
        <label for="Instructions">Instrukcje</label>
        <textarea asp-for="Instructions"></textarea>
        <span asp-validation-for="Instructions" style="color:red"></span>
    </div>

    <h3>Składniki</h3>
    <div id="ingredients-container">
        @for (int i = 0; i < Model.Ingredients.Count; i++)
        {
            <div class="ingredient-row">
                <input name="Ingredients[@i].IngredientName" placeholder="Nazwa składnika" value="@Model.Ingredients[i].IngredientName" />
                <input name="Ingredients[@i].Quantity" placeholder="Ilość" value="@Model.Ingredients[i].Quantity" />
                <button type="button" class="remove-ingredient">Usuń</button>
            </div>
        }
    </div>
    <button type="button" id="add-ingredient-btn">Dodaj składnik</button>
    <h3>Dni tygodnia</h3>
    <div class="form-check">
        @for (int i = 0; i < 7; i++)
        {
            var dayNumber = i + 1;
            var dayName = dayNumber switch
            {
                1 => "Poniedziałek",
                2 => "Wtorek",
                3 => "Środa",
                4 => "Czwartek",
                5 => "Piątek",
                6 => "Sobota",
                7 => "Niedziela",
                _ => ""
            };
            <div class="form-check form-check-inline">
                <input type="checkbox"
                       name="SelectedDays"
                       value="@dayNumber"
                @(Model.SelectedDays.Contains(dayNumber) ? "checked" : "") />
                <label class="form-check-label">@dayName</label>
            </div>
        }
    </div>


    <div style="margin-top:10px;">
        <button type="submit">Zapisz zmiany</button>
    </div>
</form>

@section Scripts {
    <script>
        let ingredientIndex = @Model.Ingredients.Count;

        // Funkcja do przepisania indeksów w inputach po zmianach
        function reindexIngredients() {
            const rows = document.querySelectorAll('#ingredients-container .ingredient-row');
            rows.forEach((row, index) => {
                row.querySelector('input[name$=".IngredientName"]').name = `Ingredients[${index}].IngredientName`;
                row.querySelector('input[name$=".Quantity"]').name = `Ingredients[${index}].Quantity`;
            });
        }

        // Obsługa przycisku "Dodaj składnik"
        document.getElementById('add-ingredient-btn').addEventListener('click', () => {
            const container = document.getElementById('ingredients-container');
            const newRow = document.createElement('div');
            newRow.classList.add('ingredient-row');
            newRow.innerHTML = `
                <input name="Ingredients[${ingredientIndex}].IngredientName" placeholder="Nazwa składnika" />
                <input name="Ingredients[${ingredientIndex}].Quantity" placeholder="Ilość" />
                <button type="button" class="remove-ingredient">Usuń</button>
            `;
            container.appendChild(newRow);

            // Dodaj event dla nowego przycisku usuń
            newRow.querySelector('.remove-ingredient').addEventListener('click', () => {
                newRow.remove();
                reindexIngredients(); // przepisz indeksy po usunięciu
            });

            ingredientIndex++;
        });

        // Obsługa istniejących przycisków "Usuń" w HTML
        document.querySelectorAll('.remove-ingredient').forEach(btn => {
            btn.addEventListener('click', () => {
                btn.parentElement.remove();
                reindexIngredients(); // przepisz indeksy po usunięciu
            });
        });
    </script>
}
