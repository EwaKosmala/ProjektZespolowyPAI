@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@model lab1_gr1.ViewModels.RecipeVM.CreateRecipeVM

@{
    ViewData["Title"] = "Edytuj przepis";

    // POPRAWKA: Pełna definicja zmiennej słownika
    var daysOfWeek = new Dictionary<int, string>
    {
        { 1, "Poniedziałek" }, { 2, "Wtorek" }, { 3, "Środa" },
        { 4, "Czwartek" }, { 5, "Piątek" }, { 6, "Sobota" }, { 0, "Niedziela" }
    };
}


<div class="container my-5">
    <div class="row">
        <div class="col-md-8 offset-md-2">

            <h2 class="mb-4">@ViewData["Title"]</h2>

            <form asp-action="Edit" asp-controller="Recipe" asp-route-id="@Model.Id" method="post">

                <input type="hidden" asp-for="Id" />

                @* Sekcja 1: Podstawowe informacje *@
                <div class="card shadow-sm mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Podstawowe informacje</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label asp-for="Name" class="form-label">Nazwa przepisu</label>
                            <input asp-for="Name" class="form-control" />
                            <span asp-validation-for="Name" class="text-danger"></span>
                        </div>
                        <div class="mb-3">
                            <label asp-for="Description" class="form-label">Krótki opis</label>
                            <textarea asp-for="Description" class="form-control" rows="3"></textarea>
                            <span asp-validation-for="Description" class="text-danger"></span>
                        </div>
                        <div class="mb-3">
                            <label asp-for="Instructions" class="form-label">Instrukcje przygotowania</label>
                            <textarea asp-for="Instructions" class="form-control" rows="8"></textarea>
                            <span asp-validation-for="Instructions" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Zaplanuj posiłek</h5>
                    </div>
                    <div class="card-body">
                        <label class="form-label">Wybierz dni tygodnia, w których chcesz zaplanować ten przepis:</label>
                        <div class="row">
                            @foreach (var day in daysOfWeek)
                            {
                                <div class="col-md-4 col-6">
                                    <div class="form-check">
                                        <input class="form-check-input"
                                               type="checkbox"
                                               name="SelectedDays"
                                               value="@day.Key"
                                               id="day-@day.Key"
                                               @(Model.SelectedDays.Contains(day.Key) ? "checked" : "") />
                                        <label class="form-check-label" for="day-@day.Key">
                                            @day.Value
                                        </label>
                                    </div>
                                </div>
                            }
                        </div>
                        <span asp-validation-for="SelectedDays" class="text-danger"></span>
                    </div>
                </div>

                <div class="card shadow-sm mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Składniki</h5>
                        <button type="button" class="btn btn-success btn-sm" onclick="addIngredient()">
                            <i class="fas fa-plus"></i> Dodaj składnik
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="ingredients-list">
                            @for (int i = 0; i < Model.Ingredients.Count; i++)
                            {
                                <div class="ingredient-row input-group mb-2">
                                    <input asp-for="@Model.Ingredients[i].IngredientName" class="form-control" placeholder="Nazwa składnika" />
                                    <input asp-for="@Model.Ingredients[i].Quantity" class="form-control" placeholder="Ilość (np. 100g, 2 szt.)" />
                                    <button type="button" class="btn btn-outline-danger" onclick="removeIngredientRow(this)">Usuń</button>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <div class="mt-4">
                    <button type="submit" class="btn btn-primary btn-lg">Zapisz zmiany</button>
                    <a asp-action="Index" class="btn btn-secondary">Anuluj</a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        function removeIngredientRow(button) {
            button.closest('.ingredient-row').remove();
            reindexIngredients();
        }

        function addIngredient() {
            var container = document.getElementById("ingredients-list");
            var index = container.getElementsByClassName("ingredient-row").length;

            var newRow = document.createElement("div");
            newRow.className = "ingredient-row input-group mb-2";

            newRow.innerHTML = `
                <input name="Ingredients[${index}].IngredientName" class="form-control" placeholder="Nazwa składnika" />
                <input name="Ingredients[${index}].Quantity" class="form-control" placeholder="Ilość (np. 100g, 2 szt.)" />
                <button type="button" class="btn btn-outline-danger" onclick="removeIngredientRow(this)">Usuń</button>
            `;

            container.appendChild(newRow);
        }

        function reindexIngredients() {
            var container = document.getElementById("ingredients-list");
            var rows = container.getElementsByClassName("ingredient-row");

            for (var i = 0; i < rows.length; i++) {
                var inputs = rows[i].getElementsByTagName("input");

                for (var j = 0; j < inputs.length; j++) {
                    if (inputs[j].name) {
                        var oldName = inputs[j].name;
                        var newName = oldName.replace(/\[\d+\]/, '[' + i + ']');
                        inputs[j].name = newName;
                    }
                }
            }
        }
    </script>
}